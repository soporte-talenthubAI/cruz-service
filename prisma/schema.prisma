generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Rol {
  ADMIN
  RRPP
  PORTERO
}

enum TipoEvento {
  NORMAL
  ESPECIAL
}

enum EstadoEntrada {
  PENDIENTE
  ENVIADO
  INGRESADO
  INVALIDADO
}

model Usuario {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  nombre    String
  rol       Rol
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entradas         Entrada[]        @relation("GeneradaPor")
  validaciones     Entrada[]        @relation("ValidadaPor")
  resetTokens      ResetToken[]
  eventosAsignados EventoUsuario[]
}

model ResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  usuarioId String
}

model Evento {
  id           String     @id @default(cuid())
  nombre       String
  fecha        DateTime
  horaApertura String
  tipo         TipoEvento @default(NORMAL)
  capacidad    Int
  flyerUrl     String?
  activo       Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  brandingBgUrl        String?
  brandingColorPrimary String?  @default("#C5A059")
  brandingColorText    String?  @default("#FFFFFF")

  entradas      Entrada[]
  rrppAsignados EventoUsuario[]
}

model EventoUsuario {
  id         String   @id @default(cuid())
  eventoId   String
  usuarioId  String
  montoPorQr Float    @default(0)
  createdAt  DateTime @default(now())

  evento  Evento  @relation(fields: [eventoId], references: [id], onDelete: Cascade)
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([eventoId, usuarioId])
  @@index([usuarioId])
  @@index([eventoId])
}

model Entrada {
  id             String        @id @default(cuid())
  nombreInvitado String
  dniInvitado    String
  emailInvitado  String
  estado         EstadoEntrada @default(PENDIENTE)
  qrCode         String        @unique @default(cuid())
  emailEnviado   Boolean       @default(false)
  fechaEnvio     DateTime?
  fechaIngreso   DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  evento        Evento  @relation(fields: [eventoId], references: [id])
  eventoId      String
  generadoPor   Usuario @relation("GeneradaPor", fields: [generadoPorId], references: [id])
  generadoPorId String
  validadoPor   Usuario? @relation("ValidadaPor", fields: [validadoPorId], references: [id])
  validadoPorId String?
}
